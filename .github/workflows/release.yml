name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.1.0)'
        required: true
        default: '0.1.0'

# Minimal permissions - only what's needed
permissions:
  contents: write  # For creating releases
  id-token: write  # For attestation

jobs:
  build:
    strategy:
      matrix:
        include:
          # Linux and Windows only - macOS uses Homebrew
          - os: ubuntu-latest
            platform: linux
            arch: x64
            bun_target: bun-linux-x64
          - os: windows-latest
            platform: windows
            arch: x64
            bun_target: bun-windows-x64

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: latest

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Build TUI (Unix)
        if: matrix.platform != 'windows'
        run: |
          mkdir -p dist/pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}
          bun build --compile --minify --target=${{ matrix.bun_target }} \
            ./src/index.tsx \
            --outfile dist/pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/pdfzen-tui

      - name: Build TUI (Windows)
        if: matrix.platform == 'windows'
        run: |
          mkdir -p dist/pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}
          bun build --compile --minify --target=${{ matrix.bun_target }} `
            ./src/index.tsx `
            --outfile dist/pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/pdfzen-tui.exe

      - name: Build Python backend
        shell: bash
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller
          
          RELEASE_DIR="../dist/pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}"
          
          if [ "${{ matrix.platform }}" = "windows" ]; then
            pyinstaller --onefile --clean --distpath "$RELEASE_DIR" --name pdfzen-backend pdfzen_backend.py
          else
            pyinstaller --onefile --clean --distpath "$RELEASE_DIR" --name pdfzen-backend pdfzen_backend.py
          fi

      - name: Create launcher (Unix)
        if: matrix.platform != 'windows'
        run: |
          RELEASE_DIR="dist/pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}"
          cat > "$RELEASE_DIR/pdfzen" << 'EOF'
          #!/bin/bash
          set -e
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          export PDFZEN_BACKEND="$SCRIPT_DIR/pdfzen-backend"
          exec "$SCRIPT_DIR/pdfzen-tui"
          EOF
          chmod +x "$RELEASE_DIR/pdfzen"

      - name: Create launcher (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $releaseDir = "dist/pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}"
          @"
          @echo off
          setlocal
          set "SCRIPT_DIR=%~dp0"
          set "PDFZEN_BACKEND=%SCRIPT_DIR%pdfzen-backend.exe"
          "%SCRIPT_DIR%pdfzen-tui.exe"
          "@ | Out-File -FilePath "$releaseDir/pdfzen.bat" -Encoding ASCII

      - name: Create archive (Unix)
        if: matrix.platform != 'windows'
        run: |
          cd dist
          tar -czf pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz \
            pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}

      - name: Create archive (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          cd dist
          Compress-Archive -Path "pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}" `
            -DestinationPath "pdfzen-${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}.zip"

      - name: Generate checksums
        shell: bash
        run: |
          cd dist
          for f in *.tar.gz *.zip; do
            [ -f "$f" ] && sha256sum "$f" > "$f.sha256"
          done

      - name: Upload artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: pdfzen-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/*.sha256

  # macOS Homebrew build (separate - uses Python source, not PyInstaller)
  build-homebrew:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Build Homebrew tarball
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_DIR="dist/pdfzen-$VERSION"
          
          mkdir -p "$RELEASE_DIR"/{lib,backend}
          
          # Compile TUI for both Apple Silicon and Intel
          bun build --compile --minify --target=bun-darwin-arm64 \
            ./src/index.tsx --outfile "$RELEASE_DIR/lib/pdfzen-tui-arm64"
          bun build --compile --minify --target=bun-darwin-x64 \
            ./src/index.tsx --outfile "$RELEASE_DIR/lib/pdfzen-tui-x64"
          
          # Create universal launcher that picks correct binary
          cat > "$RELEASE_DIR/lib/pdfzen-tui" << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          ARCH=$(uname -m)
          if [[ "$ARCH" == "arm64" ]]; then
            exec "$SCRIPT_DIR/pdfzen-tui-arm64" "$@"
          else
            exec "$SCRIPT_DIR/pdfzen-tui-x64" "$@"
          fi
          EOF
          chmod +x "$RELEASE_DIR/lib/pdfzen-tui"
          
          # Copy backend source (Homebrew installs Python deps via pip)
          cp backend/pdfzen_backend.py "$RELEASE_DIR/backend/"
          cp backend/requirements.txt "$RELEASE_DIR/backend/"
          
          # Create tarball
          cd dist
          tar -czf "pdfzen-$VERSION.tar.gz" "pdfzen-$VERSION"
          
          # Generate SHA256 checksum
          shasum -a 256 "pdfzen-$VERSION.tar.gz" > "pdfzen-$VERSION.tar.gz.sha256"
          cat "pdfzen-$VERSION.tar.gz.sha256"

      - name: Upload Homebrew artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: pdfzen-homebrew
          path: |
            dist/*.tar.gz
            dist/*.sha256

  release:
    needs: [build, build-homebrew]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate CHECKSUMS.txt
        run: |
          cd artifacts
          cat *.sha256 > CHECKSUMS.txt
          cat CHECKSUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/CHECKSUMS.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
